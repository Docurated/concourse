set -e

VERSION_FILE=/var/vcap/packages/concourse_version/version

FLY_BINARIES_FILENAME=fly_binaries/fly-$(cat $VERSION_FILE).tgz

if [ -e "$FLY_BINARIES_FILENAME" ]; then
  echo "Using existing fly binaries"

  tar -xzf $FLY_BINARIES_FILENAME ./

  for platform in linux darwin windows; do
    mkdir -p ${BOSH_INSTALL_TARGET}/${platform}/amd64

    if [ "$platform" == "windows" ]; then
      mv ./fly_${platform}_amd64.exe ${BOSH_INSTALL_TARGET}/${platform}/amd64/fly
    else
      mv ./fly_${platform}_amd64 ${BOSH_INSTALL_TARGET}/${platform}/amd64/fly
    fi
  done

else
  echo "Building fly binaries"

  REPO_NAME=github.com/concourse/fly

  export GOROOT=$(readlink -nf /var/vcap/packages/golang)
  export GOPATH=$BOSH_INSTALL_TARGET
  export PATH=$GOROOT/bin:$PATH

  mkdir ${BOSH_INSTALL_TARGET}/src
  cp -a * ${BOSH_INSTALL_TARGET}/src


  for platform in linux darwin windows; do
    mkdir -p ${BOSH_INSTALL_TARGET}/${platform}/amd64

    GOOS=${platform} GOARCH=amd64 \
      CGO_ENABLED=0 \
      go build \
        -ldflags "-X github.com/concourse/fly/version.Version=$(cat $VERSION_FILE)" \
        -o ${BOSH_INSTALL_TARGET}/${platform}/amd64/fly \
        ${REPO_NAME}
  done
fi

rm -rf ${BOSH_INSTALL_TARGET}/pkg
rm -rf ${BOSH_INSTALL_TARGET}/src
